{% extends "base.html" %}

{% block title %}Question Bank - Exam Simulator{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h2 mb-3">
                <i class="bi bi-bank me-2 text-primary"></i>Question Bank
            </h1>
            <p class="text-muted">Browse, manage, and practice with all your approved questions</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('exam') }}" class="btn btn-success btn-lg">
                <i class="bi bi-play-circle me-2"></i>
                Take Practice Exam
            </a>
        </div>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info mb-4">
        <i class="bi bi-lightbulb me-2"></i>
        <strong>How it works:</strong> Questions shown here are automatically generated from your documents.
        You can review them here, then click "Take Practice Exam" to test yourself with these questions.
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 opacity-75">Multiple Choice</h6>
                    <h2 class="card-title mb-0">{{ total_mcq }}</h2>
                    <small><i class="bi bi-list-check me-1"></i>Questions</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 opacity-75">True/False</h6>
                    <h2 class="card-title mb-0">{{ total_tf }}</h2>
                    <small><i class="bi bi-check2-circle me-1"></i>Questions</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 opacity-75">Short Answer</h6>
                    <h2 class="card-title mb-0">{{ total_sa }}</h2>
                    <small><i class="bi bi-pencil-square me-1"></i>Questions</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 opacity-75">Total Questions</h6>
                    <h2 class="card-title mb-0">{{ total_mcq + total_tf + total_sa }}</h2>
                    <small><i class="bi bi-collection me-1"></i>All Types</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>Filter Questions
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('question_bank') }}" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Document</label>
                            <select name="document_id" class="form-select" onchange="this.form.submit()">
                                <option value="">All Documents</option>
                                {% for doc in documents %}
                                <option value="{{ doc.id }}" {{ 'selected' if selected_document == doc.id else '' }}>
                                    {{ doc.filename }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Question Type</label>
                            <select name="type" class="form-select" onchange="this.form.submit()">
                                <option value="">All Types</option>
                                <option value="mcq" {{ 'selected' if selected_type == 'mcq' else '' }}>Multiple Choice</option>
                                <option value="true_false" {{ 'selected' if selected_type == 'true_false' else '' }}>True/False</option>
                                <option value="short_answer" {{ 'selected' if selected_type == 'short_answer' else '' }}>Short Answer</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select" onchange="this.form.submit()">
                                <option value="">All Status</option>
                                <option value="approved" {{ 'selected' if selected_status == 'approved' else '' }}>Approved</option>
                                <option value="pending" {{ 'selected' if selected_status == 'pending' else '' }}>Pending</option>
                                <option value="rejected" {{ 'selected' if selected_status == 'rejected' else '' }}>Rejected</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Questions List -->
    <div class="row">
        <div class="col-md-12">
            {% if questions %}
                {% for question in questions %}
                <div class="card mb-3 shadow-sm">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <span class="badge
                                    {% if question.question_type == 'mcq' %}bg-primary
                                    {% elif question.question_type == 'true_false' %}bg-success
                                    {% else %}bg-info{% endif %} me-2">
                                    {% if question.question_type == 'mcq' %}
                                        <i class="bi bi-list-check me-1"></i>MCQ
                                    {% elif question.question_type == 'true_false' %}
                                        <i class="bi bi-check2-circle me-1"></i>True/False
                                    {% else %}
                                        <i class="bi bi-pencil-square me-1"></i>Short Answer
                                    {% endif %}
                                </span>
                                <span class="badge bg-secondary">{{ question.status|title }}</span>
                                <small class="text-muted ms-2">
                                    <i class="bi bi-file-earmark-text me-1"></i>{{ question.document.filename }}
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <small class="text-muted">
                                    <i class="bi bi-calendar me-1"></i>
                                    {{ question.created_at.strftime('%b %d, %Y') }}
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">{{ question.question_text }}</h5>

                        <!-- MCQ Options -->
                        {% if question.question_type == 'mcq' and question.options_json %}
                        <div class="row mt-3">
                            {% for key, value in question.options_json.items() %}
                            <div class="col-md-6 mb-2">
                                <div class="alert {{ 'alert-success' if key == question.correct_answer else 'alert-secondary' }} mb-0 py-2">
                                    <strong>{{ key }}.</strong> {{ value }}
                                    {% if key == question.correct_answer %}
                                    <i class="bi bi-check-circle-fill text-success float-end"></i>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- True/False Answer -->
                        {% if question.question_type == 'true_false' %}
                        <div class="alert alert-success mt-3">
                            <strong><i class="bi bi-check-circle-fill me-2"></i>Correct Answer:</strong>
                            {{ 'TRUE' if question.correct_answer == 'true' else 'FALSE' }}
                        </div>
                        {% endif %}

                        <!-- Short Answer -->
                        {% if question.question_type == 'short_answer' %}
                        <div class="alert alert-info mt-3">
                            <strong><i class="bi bi-chat-left-text me-2"></i>Model Answer:</strong>
                            <p class="mb-0 mt-2">{{ question.model_answer }}</p>
                        </div>
                        {% if question.key_points %}
                        <div class="alert alert-secondary mt-2">
                            <strong><i class="bi bi-list-ul me-2"></i>Key Points:</strong>
                            <ul class="mb-0 mt-2">
                                {% for point in question.key_points %}
                                <li>{{ point }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        {% endif %}

                        <!-- Explanation (for all types) -->
                        {% if question.explanation %}
                        <div class="alert alert-warning mt-3 mb-0">
                            <strong><i class="bi bi-lightbulb me-2"></i>Explanation:</strong>
                            {{ question.explanation }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-light">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                {% if question.creator %}
                                <small class="text-muted">
                                    <i class="bi bi-person me-1"></i>Created by {{ question.creator.name }}
                                </small>
                                {% endif %}
                            </div>
                            <div class="col-md-6 text-end">
                                <form method="POST" action="{{ url_for('delete_question', question_id=question.id) }}"
                                      onsubmit="return confirm('Are you sure you want to delete this question?');"
                                      class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash me-1"></i>Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

            {% else %}
                <!-- Empty State -->
                <div class="card text-center py-5">
                    <div class="card-body">
                        <i class="bi bi-inbox display-1 text-muted mb-3"></i>
                        <h3 class="mb-3">No Questions Found</h3>
                        <p class="text-muted mb-4">
                            {% if selected_document or selected_type or selected_status %}
                                No questions match your filter criteria. Try adjusting the filters.
                            {% else %}
                                You haven't created any questions yet. Generate questions from your documents to get started!
                            {% endif %}
                        </p>
                        <a href="{{ url_for('documents') }}" class="btn btn-primary">
                            <i class="bi bi-folder me-2"></i>Go to Documents
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Action Buttons -->
    {% if questions %}
    <div class="row mt-4 mb-5">
        <div class="col-md-12 text-center">
            <a href="{{ url_for('documents') }}" class="btn btn-outline-primary">
                <i class="bi bi-plus-circle me-2"></i>Generate More Questions
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
