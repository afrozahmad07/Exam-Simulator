# Apache Configuration for Exam Simulator with Virtualmin
# This configuration should be added to your Virtualmin virtual server
#
# In Virtualmin:
# 1. Go to: Server Configuration > Edit Directives
# 2. Add these directives inside the <VirtualHost> block
# 3. Make sure mod_proxy and mod_proxy_http are enabled

# Enable required modules (if not already enabled):
# sudo dnf install mod_proxy_html
# sudo a2enmod proxy proxy_http proxy_balancer lbmethod_byrequests headers ssl rewrite

# Proxy configuration
ProxyPreserveHost On
ProxyPass /static !
ProxyPass / http://127.0.0.1:8000/
ProxyPassReverse / http://127.0.0.1:8000/

# Set headers
RequestHeader set X-Forwarded-Proto "https" env=HTTPS
RequestHeader set X-Forwarded-Port "443" env=HTTPS

# Static files - serve directly from Apache
Alias /static /home/examsim/exam-simulator/static
<Directory /home/examsim/exam-simulator/static>
    Require all granted
    Options -Indexes +FollowSymLinks
    AllowOverride None

    # Cache control for static files
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresDefault "access plus 30 days"
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
    </IfModule>

    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>
</Directory>

# Security headers
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# File upload size limit
LimitRequestBody 16777216

# Error logging
ErrorLog ${APACHE_LOG_DIR}/examsimulator_error.log
CustomLog ${APACHE_LOG_DIR}/examsimulator_access.log combined

# Compression
<IfModule mod_deflate.c>
    SetOutputFilter DEFLATE
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|pdf)$ no-gzip dont-vary
    Header append Vary User-Agent env=!dont-vary
</IfModule>

# Optional: Force HTTPS redirect (uncomment after SSL is set up)
# <IfModule mod_rewrite.c>
#     RewriteEngine On
#     RewriteCond %{HTTPS} off
#     RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
# </IfModule>
